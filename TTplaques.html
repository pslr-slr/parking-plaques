<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>V√©rification Plaques Parking</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
    h1 { margin: 10px; }
    video { width: 90%; border: 2px solid #333; border-radius: 12px; margin-top: 10px; }
    #result { font-size: 2em; margin-top: 15px; font-weight: bold; }
    .ok { color: green; }
    .not-ok { color: red; }
    button { margin: 8px; padding: 10px 15px; font-size: 1em; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Contr√¥le des plaques</h1>
  <input type="file" id="fileInput" accept=".csv" />
  <br>
  <button id="startCam">üì∑ D√©marrer cam√©ra</button>
  <button id="scanBtn">üîé Scanner plaque</button>
  <br>
  <video id="video" autoplay playsinline></video>
  <div id="result"></div>

  <script>
    let authorizedPlates = [];

    // Charger le fichier CSV
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        authorizedPlates = event.target.result.split(/\r?\n/).map(p => p.trim().toUpperCase());
        alert("Fichier charg√©: " + authorizedPlates.length + " plaques");
      };
      reader.readAsText(file);
    });

    // D√©marrer cam√©ra avec mediaDevices
    const video = document.getElementById('video');
    document.getElementById('startCam').addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("getUserMedia non support√© par ce navigateur.");
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
      } catch (err) {
        alert("Erreur acc√®s cam√©ra: " + err);
      }
    });

    // Scanner l'image depuis la vid√©o
    document.getElementById('scanBtn').addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      document.getElementById('result').textContent = "Analyse en cours...";

      const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
      let detected = text.replace(/\s+/g, '').toUpperCase();

      let resultDiv = document.getElementById('result');
      if (authorizedPlates.includes(detected)) {
        resultDiv.innerHTML = `‚úÖ Autoris√©<br>${detected}`;
        resultDiv.className = "ok";
      } else {
        resultDiv.innerHTML = `‚ùå Pas autoris√©<br>${detected}`;
        resultDiv.className = "not-ok";
      }
    });
  </script>
</body>
</html>
