<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>V√©rification Plaques Parking</title>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; }
    h1 { margin: 10px; }
    video { width: 90%; border: 2px solid #333; border-radius: 12px; margin-top: 10px; }
    #result { font-size: 2em; margin-top: 15px; font-weight: bold; }
    #lastUpdate { font-size: 0.9em; margin-top: 5px; color: #555; }
    .ok { color: green; }
    .not-ok { color: red; }
    button { margin: 8px; padding: 10px 15px; font-size: 1em; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Contr√¥le des plaques</h1>
  <div id="lastUpdate">Chargement de la liste...</div>
  <button id="startCam">üì∑ D√©marrer cam√©ra</button>
  <button id="scanBtn">üîé Scanner plaque</button>
  <br>
  <video id="video" autoplay playsinline></video>
  <div id="result"></div>

  <script>
    let authorizedPlates = [];
    const repoOwner = 'TON_COMPTE'; // remplace par ton nom GitHub
    const repoName = 'parking-plaques'; // nom du repo
    const csvFile = 'plaques.csv'; // nom du fichier CSV dans le repo

    // Charger le CSV depuis GitHub
    async function loadCSV() {
      try {
        // R√©cup√©rer le contenu brut du CSV
        const csvUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${csvFile}`;
        const response = await fetch(csvUrl);
        const text = await response.text();
        authorizedPlates = text.split(/\r?\n/).map(p => p.trim().toUpperCase());

        // R√©cup√©rer la date de derni√®re mise √† jour via l'API GitHub
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${csvFile}`;
        const apiResponse = await fetch(apiUrl);
        const json = await apiResponse.json();
        const lastUpdate = new Date(json.commit?.committer?.date || json.last_modified || Date.now());

        document.getElementById('lastUpdate').textContent = `Derni√®re mise √† jour du CSV : ${lastUpdate.toLocaleString()}`;

      } catch (err) {
        alert('Erreur lors du chargement du CSV: ' + err);
      }
    }

    loadCSV();

    // D√©marrer cam√©ra avec mediaDevices
    const video = document.getElementById('video');
    document.getElementById('startCam').addEventListener('click', async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("getUserMedia non support√© par ce navigateur.");
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
      } catch (err) {
        alert("Erreur acc√®s cam√©ra: " + err);
      }
    });

    // Scanner l'image depuis la vid√©o
    document.getElementById('scanBtn').addEventListener('click', async () => {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);

      document.getElementById('result').textContent = "Analyse en cours...";

      const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
      let detected = text.replace(/\s+/g, '').toUpperCase();

      let resultDiv = document.getElementById('result');
      if (authorizedPlates.includes(detected)) {
        resultDiv.innerHTML = `‚úÖ Autoris√©<br>${detected}`;
        resultDiv.className = "ok";
      } else {
        resultDiv.innerHTML = `‚ùå Pas autoris√©<br>${detected}`;
        resultDiv.className = "not-ok";
      }
    });
  </script>
</body>
</html>
