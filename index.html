<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Appli Photo</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    .overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 250px;
      height: 250px;
      margin-left: -125px;
      margin-top: -125px;
      border: 4px solid rgba(0, 150, 255, 0.7);
      border-radius: 50%;
      pointer-events: none;
      display: none; /* invisible par d√©faut */
    }
    video, canvas { width: 100%; max-width: 400px; border-radius: 10px; }
  </style>
</head>
<body>
  <h2>Formulaire Photo</h2>
  <form id="infoForm">
    <input type="text" id="nom" placeholder="Nom" required><br><br>
    <input type="text" id="prenom" placeholder="Pr√©nom" required><br><br>
    <input type="text" id="societe" placeholder="Soci√©t√©" required><br><br>
  </form>

  <button onclick="startCamera()">üì∑ Prendre la photo</button>
  <div style="position:relative; display:inline-block;">
    <video id="video" autoplay playsinline></video>
    <div id="overlay" class="overlay"></div>
  </div>
  <br>
  <button onclick="capturePhoto()">‚úÖ Capturer</button>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    let video = document.getElementById("video");
    let canvas = document.getElementById("canvas");
    let context = canvas.getContext("2d");
    let overlay = document.getElementById("overlay");
    let stream;

    async function startCamera() {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "user" } 
      });
      video.srcObject = stream;
      overlay.style.display = "block"; // afficher cercle seulement quand la cam√©ra d√©marre
    }

    function sanitize(text) {
      return text.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    }

    function capturePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Convertir en JPG
      canvas.toBlob(function(blob) {
        let nom = document.getElementById("nom").value.trim();
        let prenom = document.getElementById("prenom").value.trim();
        let societe = document.getElementById("societe").value.trim();

        let filename = sanitize(societe) + "-" + sanitize(nom) + "-" + sanitize(prenom) + ".jpg";

        // Ouvrir email pr√©-rempli (‚ö†Ô∏è sans PJ, limitation du mailto)
        let a = document.createElement("a");
        a.href = "mailto:pascal.seillier@gmail.com"
              + "?subject=Photo%20-" + encodeURIComponent(nom + " " + prenom)
              + "&body=" + encodeURIComponent("Nom: " + nom + "\nPr√©nom: " + prenom + "\nSoci√©t√©: " + societe + "\n\n‚ö†Ô∏è Merci d'ajouter la photo en pi√®ce jointe.");
        a.click();

        // T√©l√©chargement auto de la photo ‚Üí l‚Äôutilisateur peut l‚Äôattacher ensuite
        let imgURL = URL.createObjectURL(blob);
        let download = document.createElement("a");
        download.href = imgURL;
        download.download = filename;
        download.click();
      }, "image/jpeg", 0.9);
    }
  </script>
</body>
</html>
